name: EditMode CI (Self-Hosted)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  editmode-tests:
    name: Unity EditMode Tests (Self-Hosted)
    runs-on: [self-hosted, Windows]

    env:
      UNITY_VERSION: 6000.1.14f1   # update if you change your local Unity install

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Allow PowerShell scripts in THIS job only (no machine-wide change)
      - name: Allow PowerShell scripts (process scope)
        shell: powershell
        run: |
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          $PSVersionTable.PSVersion

      - name: Prepare workspace
        shell: powershell
        run: |
          $results = Join-Path "${{ github.workspace }}" "TestResults"
          if (Test-Path $results) { Remove-Item $results -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $results | Out-Null

      - name: Run Unity EditMode Tests
        shell: powershell
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\${{ env.UNITY_VERSION }}\Editor\Unity.exe"
          if (!(Test-Path $unityExe)) {
            Write-Error "Unity not found at $unityExe. Check version or install path."
          }
          & "$unityExe" -batchmode -nographics -quit `
            -projectPath "${{ github.workspace }}" `
            -logfile "${{ github.workspace }}\TestResults\EditModeLog.txt" `
            -runTests -testPlatform EditMode `
            -testResults "${{ github.workspace }}\TestResults\EditModeResults.xml"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: EditModeResults
          path: TestResults/
