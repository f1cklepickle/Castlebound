name: EditMode CI (Self-Hosted)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  editmode-tests:
    name: Unity EditMode Tests (Self-Hosted)
    runs-on: [self-hosted, Windows]

    env:
      UNITY_VERSION: 6000.1.14f1  # update when you upgrade Unity on the runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Allow pwsh script execution for THIS JOB ONLY (no machine change)
      - name: Allow pwsh in this job
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

      # Locate Unity.exe for the given UNITY_VERSION and export to GITHUB_ENV
      - name: Locate Unity.exe
        shell: pwsh
        run: |
          $version = "${{ env.UNITY_VERSION }}"
          $roots = @(
            "C:\Program Files\Unity\Hub\Editor",
            "C:\Program Files\Unity\Hub",
            "C:\Program Files\Unity",
            "$Env:ProgramFiles\Unity\Hub\Editor"
          ) | Select-Object -Unique

          $unityExe = $null
          foreach ($r in $roots) {
            $candidate = Join-Path $r $version | Join-Path -ChildPath "Editor\Unity.exe"
            if (Test-Path $candidate) { $unityExe = $candidate; break }
          }

          if (-not $unityExe) {
            # Fallback: narrow search to versioned paths first to avoid false hits
            $unityExe = Get-ChildItem -Path 'C:\' -Filter Unity.exe -ErrorAction SilentlyContinue -Recurse |
              Where-Object { $_.FullName -match [regex]::Escape($version) } |
              Select-Object -First 1 -ExpandProperty FullName
          }

          if (-not $unityExe) {
            Write-Error "Unity $version not found on this runner. Install via Unity Hub."
            exit 1
          }

          "UNITY_EXE=$unityExe" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Prepare workspace (cmd)
        shell: cmd
        run: |
          if exist "%CD%\TestResults" rmdir /s /q "%CD%\TestResults"
          mkdir "%CD%\TestResults"

      - name: Run Unity EditMode Tests (cmd)
        shell: cmd
        run: |
          if not exist "%UNITY_EXE%" (
            echo Unity not found at "%UNITY_EXE%"
            exit /b 1
          )
          "%UNITY_EXE%" -batchmode -nographics -quit ^
            -projectPath "%CD%" ^
            -logfile "%CD%\TestResults\EditModeLog.txt" ^
            -runTests -testPlatform EditMode ^
            -testResults "%CD%\TestResults\EditModeResults.xml"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: EditModeResults
          path: TestResults/
